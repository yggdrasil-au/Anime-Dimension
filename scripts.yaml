##
# Scripts Configuration File
#
# all scripts normally found in package.json scripts section
#
# main scripts are:
#   - build: build simply produces the website in www/
#   - production: builds the website with optimization, linting, etc.
#   - dev: builds the website and starts a local apache server with watch mode
#   - dev-prod: same as dev but uses production build
#
#   - dotnet:run: runs the .NET API in debug mode locally, accessable at http://localhost:5000 or api_dev.anime-dimension.com
#   - dotnet:build-release-linux: builds the .NET API for Linux deployment
#   - dotnet:build-release-win: builds the .NET API for Windows deployment
#
#   - deploy-prod: builds the prod site and dotnet api and deploys to the server
#   - ww-d: builds and deploys only the website to the server
#   - api-d: builds and deploys only the .NET API to the server
#   - update-api-www-no-build and update-api-www: updates website embedded in the dotnet api from the astro build, one builds astro first, the other does not,
#     the dotnet:build-release-linux runs no build making it rely on existing astro build
#
#   - Most Other scripts are sub-scripts used by the main scripts, but most can be run directly when testing or debugging specific parts of the build process
##

#
# command line example:
#   in webdev root:
#       pnpm --filter anime-dimension yaml-run dev
#   in anime-dimension main dir:
#       pnpm yaml-run dev
#


scripts:
    # --- Utilities ---
    #echo: "echo {{pkg.buildConfig.banner}}"

    clean:
        - "rimraf {{paths.www}}/"
    clean-www-website-html:
        - "rimraf {{paths.web_root}}/**/*.html"
    clean-www-dist-html:
        - "rimraf {{paths.web_dist}}/**/*.html"


    watch: "node scripts/watch-updates.mjs"

    lint:
        parallel:
            - js-lint
            - css-lint
            - docs-lint

    # --- Icons & Assets ---
    copy-icons:bi: >
        shx mkdir -p {{paths.bi_dist}} &&
        shx cp -r {{paths.bi_src}}/* {{paths.bi_dist}}/

    copy-icons:fa: >
        shx mkdir -p {{paths.bi_dist}}/fontawesome &&
        shx cp -r {{paths.fa_src}} {{paths.fa_dist}}/

    copy-icons:www:
        series:
            - copy-icons:bi
            - copy-icons:fa

    assets:icons: copy-icons:www

    webp: >
        shx mkdir -p ./{{paths.img_dist}} &&
        ygg-webp --inputDir ./{{paths.img_src}} --outputDir ./{{paths.img_dist}} --configPath ./{{paths.webp_conf}}

    assets:handle:  "node scripts/asset-handler.mjs --split"
    assets:prod:    "node scripts/asset-handler.mjs --production"
    assets:dev:     "node scripts/asset-handler.mjs --dev"
    assets:prepare: "node scripts/asset-handler.mjs --prepare"

    appAssetsGen: >
        capacitor-assets generate --android --pwa
        --pwaOutRoot {{paths.pwa_out}}
        --pwaIconsPath {{paths.pwa_icons}}
        --pwaManifestPath {{paths.pwa_manifest}}
        --assetPath {{paths.pwa_assets}}

    # --- CSS ---
    css:
        series:
            - css-compile
            - css-prefix
            - css-rtl
            - css-minify

    css-compile: >
        sass --style expanded --load-path="node_modules"
        --source-map --embed-sources --no-error-css --quiet
        {{paths.scss}}/:{{paths.css_dist}}/

    css-rtl: >
        cross-env NODE_ENV=RTL postcss --config {{configs.postcss}}
        --dir "{{paths.css_dist}}" --ext ".rtl.css"
        "{{paths.css_dist}}/*.css" "!{{paths.css_dist}}/*.min.css" "!{{paths.css_dist}}/*.rtl.css"

    css-lint: 'stylelint "{{paths.scss}}/**/*.scss" --cache --cache-location .cache/.stylelintcache --rd'

    css-prefix: 'postcss --config {{configs.postcss}} --replace "{{paths.css_dist}}/*.css" "!{{paths.css_dist}}/*.rtl*.css" "!{{paths.css_dist}}/*.min.css"'

    css-minify:
        parallel:
            - css-minify-main
            - css-minify-rtl

    css-minify-main: >
        cleancss -O1 --format breakWith=lf --with-rebase --source-map --source-map-inline-sources
        --output {{paths.css_dist}}/ --batch --batch-suffix ".min"
        "{{paths.css_dist}}/*.css" "!{{paths.css_dist}}/*.min.css" "!{{paths.css_dist}}/*rtl*.css"

    css-minify-rtl: >
        cleancss -O1 --format breakWith=lf --with-rebase --source-map --source-map-inline-sources
        --output {{paths.css_dist}}/ --batch --batch-suffix ".min"
        "{{paths.css_dist}}/*rtl.css" "!{{paths.css_dist}}/*.min.css"

    # --- JS ---
    js:
        series:
            - js-compile
            - js-min

    js:prod:
        series:
            - js-compile:prod
            - js-min:prod

    js-compile: "ts-builder"
    js-compile:prod: "ts-builder --no-source-map"
    js-lint: "eslint --format=stylish ."
    js-min: "js-minify --inputDir {{paths.web_root}} --inputDir {{paths.web_dist}} --inputDir {{paths.cap_sync}}"
    js-min:prod: "js-minify --inputDir {{paths.web_root}} --inputDir {{paths.web_dist}} --inputDir {{paths.cap_sync}} --no-sourcemap --delete-source"

    # --- HTML / Docs ---
    htm-minify: "htm-minify --inputDir {{paths.web_root}} --inputDir {{paths.web_dist}} --inputDir {{paths.cap_sync}} --parallel cpu"

    docs-compile: "astro --config {{configs.astro}} build"
    docs-compile-silent: "astro --config {{configs.astro}} build --silent"
    docs-lint: "astro --config {{configs.astro}} check"
    docs-format: 'prettier --write "{{paths.web_dist}}/**/*.html"'
    docs-serve-ssr: "astro --config {{configs.astro_ssr}} dev --port 3001"

    move-astro-output-to-dist: "shx cp -r {{paths.web_dist}}/astrobuild/* {{paths.web_dist}}/ && shx rm -rf {{paths.web_dist}}/astrobuild"

    # --- Build Pipelines ---
    generate-data: "node scripts/generate-offline-data.mjs"

    comp2:
        series:
            - assets:prepare
            - assets:icons
            - docs-compile-silent
            #- docs-compile

    compile-parallel:
        parallel:
            - css
            - js
            - webp

    compile-parallel:prod:
        parallel:
            - css
            - js:prod
            - webp

    compile:
        series:
            - compile-parallel
            - comp2
            - docs-format
            - move-astro-output-to-dist
            - generate-data
            - assets:handle

    compile:prod:
        series:
            - compile-parallel:prod
            - comp2
            - docs-format
            - move-astro-output-to-dist
            - generate-data
            - assets:handle


    # main
    build:
        series:
            - clean
            - compile

    prod-comp:
        series:
            - clean
            - appAssetsGen
            - compile:prod
            - htm-minify

    # main
    production:
        series:
            - assets:prod
            - clean
            - appAssetsGen
            - lint
            - compile:prod
            - htm-minify
            - capSync

    capSync: "pnpm exec cap sync"

    # --- Dev / Watch ---
    dev-apache-server: "wlampctl-cli apache start --output --DocumentRoot ./{{paths.web_root}} --port 8080"

    dev-apache-watch:
        parallel:
            - watch
            - dev-apache-server

    # main
    dev:
        series:
            - assets:dev
            - build
            - dev-apache-watch

    # main
    dev-prod:
        series:
            - assets:prod
            - production
            - dev-apache-watch

    # --- PHP Build ---
    # these three allow for php <?php ?> tags to be inside .astro files by commenting them out before astrobuild and restoring them in source and output after
    # this is currently unused and would require re-adding php execution to the watch-updates.mjs script to function in dev mode
    #build:php: "build-php full"
    #php:prebuild: "build-php pre"   ## run anytime before astro build to prepare .astro files with php tags
    #php:postbuild: "build-php post" ## run only after all html related build steps are done to restore php tags in source and html output
    # to use pure .php files simply place them in source/web these files are always in www/dist and www/website as-is not included in www/capacitorsync and is not processed by any tools

    ##
    # --- .NET API ---
    ##

    update-api-www-no-build: "node scripts/asset-handler.mjs --update-api"
    update-api-www:
        - compile
        - update-api-www-no-build

    # main
    dotnet:run: "cd {{paths.api_dir}} && dotnet run -c Debug --project ./{{paths.api_proj}} --framework net10.0"

    # main
    dotnet:build-release-linux: >
        yaml-run update-api-www-no-build && cd {{paths.api_dir}} && rimraf {{paths.api_pub_linux}} &&
        dotnet publish ./{{paths.api_proj}} -c Release -f net10.0 -r linux-x64 --self-contained true
        -p:PublishSingleFile=true -p:PublishTrimmed=true -p:IncludeAllContentForSelfExtract=true -o {{paths.api_pub_linux}}

    # main
    dotnet:build-release-linux-arm: >
        yaml-run update-api-www-no-build && cd {{paths.api_dir}} && rimraf {{paths.api_pub_linux_arm}} &&
        dotnet publish ./{{paths.api_proj}} -c Release -f net10.0 -r linux-arm64 --self-contained true
        -p:PublishSingleFile=true -p:PublishTrimmed=true -p:IncludeAllContentForSelfExtract=true -o {{paths.api_pub_linux_arm}}

    # main
    dotnet:build-release-win: >
        yaml-run update-api-www && cd {{paths.api_dir}} && rimraf {{paths.api_pub_win}} &&
        dotnet publish ./{{paths.api_proj}} -c Release -f net10.0 -r win-x64 --self-contained true
        -p:PublishSingleFile=true -p:PublishTrimmed=true -p:IncludeAllContentForSelfExtract=true -o {{paths.api_pub_win}}

    # --- Deployment ---
    #deploy:check: "deploy --check"
    #deploy:sftp: "deploy"
    # Static frontend website deployment, us and eu servers
    netdeploy:www-us: "netdeploy --www-us"
    netdeploy:www-eu: "netdeploy --www-eu"
    #deploy:www: "deploy --www-us"
    #deploy:www-eu: "deploy --www-eu"
    # C# API backend deployment, us and eu-arm servers
    netdeploy:cs-us: "netdeploy --cs-us"
    netdeploy:cs-eu-arm: "netdeploy --cs-eu-arm"
    #deploy:cs: "deploy --cs-us"
    #deploy:cs-eu-arm: "deploy --cs-eu-arm"

    ww-d:
        series:
            - production
            - netdeploy:www-us
            - netdeploy:www-eu

    # build website as prod, then build the us api then upload www only to us server
    ww-d-us:
        series:
            - production
            - dotnet:build-release-linux
            - netdeploy:www-us

    # build and deploy only US C# API backend
    api-d:
        series:
            - dotnet:build-release-linux
            - netdeploy:cs-us

    # build and deploy only EU ARM C# API backend
    api-d-arm:
        series:
            - dotnet:build-release-linux-arm
            - netdeploy:cs-eu-arm

    # deploy all api and www to production servers
    deploy-prod:
        series:
            - ww-d
            - api-d
            - api-d-arm

    # deploy only API to production servers
    deploy-api-only:
        series:
            - api-d
            - api-d-arm
